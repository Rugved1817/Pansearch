<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Cart ‚Ä¢ Pansearch</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg: #0a0d12;
			--bg-2: #0b1118;
			--panel: rgba(12,18,26,0.92);
			--border: #1a2431;
			--border-light: rgba(155,140,255,0.25);
			--text: #eaf1f8;
			--muted: #9fb2c6;
			--accent: #9b8cff;
			--danger: #ff6b6b;
		}
		* { box-sizing: border-box; margin: 0; padding: 0; }
		body {
			min-height: 100vh;
			background:
				radial-gradient(1200px 700px at 8% -8%, rgba(96,213,255,0.08), transparent 65%),
				radial-gradient(900px 600px at 100% 0%, rgba(155,140,255,0.09), transparent 60%),
				linear-gradient(180deg, var(--bg), var(--bg-2));
			color: var(--text);
			font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
			padding: 32px 16px 48px;
		}
		.container {
			max-width: 1080px;
			margin: 0 auto;
		}
		.header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 16px;
			margin-bottom: 28px;
			padding-bottom: 20px;
			border-bottom: 1px solid var(--border);
		}
		h1 {
			font-size: 30px;
			font-weight: 700;
			background: linear-gradient(135deg, #9b8cff, #60d5ff);
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			letter-spacing: -0.4px;
		}
		.nav-button {
			display: inline-flex;
			align-items: center;
			gap: 10px;
			background: linear-gradient(135deg, rgba(155,140,255,0.15), rgba(96,213,255,0.12));
			padding: 10px 18px;
			border-radius: 999px;
			color: #d7deff;
			text-decoration: none;
			font-weight: 600;
			border: 1px solid rgba(155,140,255,0.3);
			box-shadow: 0 8px 20px rgba(155,140,255,0.15);
			transition: all 0.25s ease;
		}
		.nav-button:hover {
			transform: translateY(-1px);
			box-shadow: 0 12px 26px rgba(155,140,255,0.25);
		}
		.card {
			background: var(--panel);
			border: 1px solid var(--border-light);
			border-radius: 20px;
			box-shadow: 0 24px 60px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.03) inset;
			padding: 24px;
			backdrop-filter: saturate(120%) blur(12px);
		}
		.cart-empty {
			text-align: center;
			padding: 48px 16px;
			color: var(--muted);
			font-size: 15px;
		}
		.cart-controls {
			display: flex;
			justify-content: flex-end;
			align-items: center;
			gap: 12px;
			margin-bottom: 20px;
			flex-wrap: wrap;
		}
		.btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
			background: linear-gradient(135deg, rgba(37,50,70,0.75), rgba(27,37,51,0.85));
			color: #e8f3ff;
			padding: 10px 18px;
			border-radius: 12px;
			border: 1px solid rgba(30,42,58,0.8);
			cursor: pointer;
			font-size: 13px;
			font-weight: 600;
			transition: all 0.2s ease;
			text-decoration: none;
		}
		.btn:hover {
			transform: translateY(-1px);
			filter: brightness(1.1);
		}
		.btn-danger {
			background: linear-gradient(135deg, rgba(255,107,107,0.18), rgba(255,107,107,0.26));
			border-color: rgba(255,107,107,0.5);
			color: #ffdada;
		}
		.table-wrap {
			overflow-x: auto;
			border-radius: 16px;
			border: 1px solid rgba(30,42,58,0.8);
		}
		table {
			width: 100%;
			border-collapse: collapse;
			min-width: 640px;
		}
		thead th {
			text-align: left;
			text-transform: uppercase;
			letter-spacing: 0.4px;
			font-size: 12px;
			padding: 14px 16px;
			background: rgba(16,24,36,0.9);
			color: #cfd8ff;
			position: sticky;
			top: 0;
		}
		tbody td {
			padding: 14px 16px;
			border-bottom: 1px solid rgba(28,37,50,0.65);
			font-size: 13px;
			color: #e0e8ff;
		}
		tbody tr:nth-child(even) {
			background: rgba(12,18,27,0.75);
		}
		.cart-remove {
			background: rgba(255,107,107,0.22);
			border: 1px solid rgba(255,107,107,0.45);
			color: #ff9a9a;
			padding: 6px 12px;
			border-radius: 10px;
			font-size: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		.cart-remove:hover {
			background: rgba(255,107,107,0.35);
			color: #ffecec;
		}
		.toast {
			position: fixed;
			right: 24px;
			bottom: 24px;
			padding: 12px 16px;
			border-radius: 12px;
			background: linear-gradient(135deg, rgba(18,32,52,0.9), rgba(12,24,40,0.92));
			border: 1px solid rgba(155,140,255,0.3);
			color: #eaf1f8;
			box-shadow: 0 12px 28px rgba(0,0,0,0.4);
			display: none;
			z-index: 100;
		}
		.toast.show {
			display: block;
			animation: fade 2.4s ease forwards;
		}
		@keyframes fade {
			0% { opacity: 0; transform: translateY(12px); }
			10% { opacity: 1; transform: translateY(0); }
			90% { opacity: 1; transform: translateY(0); }
			100% { opacity: 0; transform: translateY(12px); }
		}
		.project-selector {
			position: relative;
			display: inline-block;
		}
		.project-selector-btn {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			padding: 12px 16px;
			background: rgba(12,19,27,0.8);
			border: 1px solid var(--border);
			border-radius: 12px;
			color: var(--text);
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			min-width: 220px;
		}
		.project-selector-btn:hover {
			border-color: var(--border-light);
			background: rgba(12,19,27,0.95);
		}
		.project-selector-btn.active {
			border-color: var(--accent);
			box-shadow: 0 0 0 3px rgba(155,140,255,0.2);
		}
		.project-selector-btn .arrow {
			transition: transform 0.2s ease;
			font-size: 12px;
			color: var(--muted);
		}
		.project-selector-btn.active .arrow {
			transform: rotate(180deg);
		}
		.project-dropdown {
			position: absolute;
			top: calc(100% + 8px);
			left: 0;
			right: 0;
			background: var(--panel);
			border: 1px solid var(--border-light);
			border-radius: 12px;
			box-shadow: 0 12px 32px rgba(0,0,0,0.5);
			z-index: 1000;
			display: none;
			max-height: 400px;
			overflow-y: auto;
		}
		.project-dropdown.show {
			display: block;
		}
		.project-item {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 12px 16px;
			cursor: pointer;
			transition: all 0.2s ease;
			border-bottom: 1px solid var(--border);
		}
		.project-item:last-child {
			border-bottom: none;
		}
		.project-item:hover {
			background: rgba(155,140,255,0.1);
		}
		.project-item.active {
			background: rgba(155,140,255,0.15);
			border-left: 3px solid var(--accent);
		}
		.project-item-info {
			flex: 1;
			min-width: 0;
		}
		.project-item-name {
			font-weight: 600;
			color: var(--text);
			font-size: 14px;
			margin-bottom: 2px;
		}
		.project-item-count {
			font-size: 12px;
			color: var(--muted);
		}
		.project-item-actions {
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.project-delete-btn {
			background: rgba(255,107,107,0.15);
			border: 1px solid rgba(255,107,107,0.3);
			color: #ff6b6b;
			padding: 6px 10px;
			border-radius: 8px;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.project-delete-btn:hover {
			background: rgba(255,107,107,0.25);
			border-color: rgba(255,107,107,0.5);
			transform: scale(1.05);
		}
		.project-delete-btn:active {
			transform: scale(0.95);
		}
		@media (max-width: 720px) {
			h1 { font-size: 26px; }
			.card { padding: 20px; }
			thead th, tbody td { padding: 12px; }
			.project-selector-btn { min-width: 180px; }
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>Cart</h1>
			<a class="nav-button" href="index.html" title="Back to search">‚Üê Back to Search</a>
		</div>

		<div class="card">
			<div class="cart-controls">
				<div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
					<label style="color: var(--muted); font-size: 14px; font-weight: 600;">Project:</label>
					<div class="project-selector">
						<button id="projectSelectorBtn" class="project-selector-btn">
							<span id="projectSelectorText">Loading...</span>
							<span class="arrow">‚ñº</span>
						</button>
						<div id="projectDropdown" class="project-dropdown">
							<!-- Projects will be populated here -->
						</div>
					</div>
					<button id="btnNewProject" class="btn" style="font-size: 12px; padding: 8px 14px;">+ New Project</button>
				</div>
				<div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
					<span id="cartStatus" style="color: var(--muted); font-size: 14px;">Loading‚Ä¶</span>
					<button id="btnExportCSV" class="btn">Export CSV</button>
					<button id="btnExportPDF" class="btn">Export PDF</button>
					<button id="btnClearCart" class="btn btn-danger">Clear Project</button>
				</div>
			</div>
			<div id="cartContent"></div>
		</div>
	</div>

	<div id="toast" class="toast"></div>

	<script>
	const CART_STORAGE_KEY = 'pansearch_cart_v2';
	const API_BASE = (location.protocol === 'file:') ? 'http://localhost:8000' : `${location.protocol}//${location.hostname || 'localhost'}:8000`;

	const el = id => document.getElementById(id);

	const showToast = (msg) => {
		const t = el('toast');
		t.textContent = msg;
		t.classList.add('show');
		setTimeout(() => t.classList.remove('show'), 2400);
	};

	const getProjects = () => {
		try {
			const raw = localStorage.getItem(CART_STORAGE_KEY);
			if (!raw) {
				const defaultData = {
					projects: { 'default': { name: 'Default Project', items: [] } },
					currentProject: 'default'
				};
				localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(defaultData));
				return defaultData;
			}
			const parsed = JSON.parse(raw);
			// Migrate old format
			if (Array.isArray(parsed)) {
				const migrated = {
					projects: { 'default': { name: 'Default Project', items: parsed } },
					currentProject: 'default'
				};
				localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(migrated));
				return migrated;
			}
			return parsed;
		} catch (err) {
			console.warn('Failed to load projects', err);
			return {
				projects: { 'default': { name: 'Default Project', items: [] } },
				currentProject: 'default'
			};
		}
	};

	const saveProjects = (projectsData) => {
		try {
			localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(projectsData));
		} catch (err) {
			console.warn('Failed to save projects', err);
		}
	};

	const getCurrentProject = () => {
		const data = getProjects();
		return data.currentProject || 'default';
	};

	const setCurrentProject = (projectId) => {
		const data = getProjects();
		data.currentProject = projectId;
		saveProjects(data);
	};

	const getProjectItems = (projectId) => {
		const data = getProjects();
		const project = data.projects[projectId || data.currentProject];
		if (!project) return new Map();
		return new Map(project.items.map(item => [item.key, item.row]));
	};

	const loadCart = () => {
		const currentProjectId = getCurrentProject();
		return getProjectItems(currentProjectId);
	};

	const saveCart = (map) => {
		const data = getProjects();
		const currentProjectId = getCurrentProject();
		if (!data.projects[currentProjectId]) {
			data.projects[currentProjectId] = { name: 'Default Project', items: [] };
		}
		data.projects[currentProjectId].items = Array.from(map.entries()).map(([key, row]) => ({ key, row }));
		saveProjects(data);
	};

	const formatField = (row, keys) => {
		for (const key of keys) {
			if (row && row[key] !== undefined && row[key] !== null) {
				const text = String(row[key]).trim();
				if (text) return text;
			}
		}
		return '';
	};

const exportCartCSV = () => {
	const cart = loadCart();
	if (!cart.size) {
		showToast('Project is empty');
		return;
	}
	const data = getProjects();
	const currentProjectId = getCurrentProject();
	const project = data.projects[currentProjectId];
	const projectName = project ? project.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'project';
	
	const headers = ['PAN', 'Buyer', 'Seller', 'Doc No', 'Year'];
	const rows = [headers.join(',')];
	for (const [, row] of cart.entries()) {
		const values = [
			formatField(row, ['pan_numbers', 'PAN', 'pan']),
			formatField(row, ['buyer', 'Buyer']).replace(/,/g, ';'),
			formatField(row, ['seller', 'Seller']).replace(/,/g, ';'),
			formatField(row, ['DocNo', 'doc_no', 'docno', 'DocumentNo']),
			formatField(row, ['year', 'Year', 'YEAR'])
		];
		rows.push(values.map(val => {
			const v = val ?? '';
			return /[",\n]/.test(v) ? `"${v.replace(/"/g, '""')}"` : v;
		}).join(','));
	}
	const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
	const url = URL.createObjectURL(blob);
	const a = document.createElement('a');
	a.href = url;
	a.download = `${projectName}_${new Date().toISOString().split('T')[0]}.csv`;
	a.click();
	URL.revokeObjectURL(url);
	showToast('CSV exported');
};

const exportCartPDF = async () => {
	const cart = loadCart();
	if (!cart.size) {
		showToast('Project is empty');
		return;
	}
	const data = getProjects();
	const currentProjectId = getCurrentProject();
	const project = data.projects[currentProjectId];
	const projectName = project ? project.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'project';
	
	try {
		const res = await fetch(`${API_BASE}/export_pdf`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ rows: Array.from(cart.values()), search_pan: null })
		});
		if (!res.ok) throw new Error(await res.text());
		const blob = await res.blob();
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = `${projectName}_${new Date().toISOString().split('T')[0]}.pdf`;
		a.click();
		URL.revokeObjectURL(url);
		showToast('PDF exported');
	} catch (err) {
		console.error(err);
		showToast('PDF export failed');
	}
};

	const populateProjectSelect = () => {
		const dropdown = el('projectDropdown');
		const selectorText = el('projectSelectorText');
		if (!dropdown || !selectorText) return;
		
		const data = getProjects();
		const currentProjectId = data.currentProject || 'default';
		const currentProject = data.projects[currentProjectId];
		
		// Update selector button text
		if (currentProject) {
			selectorText.textContent = `${currentProject.name} (${currentProject.items.length})`;
		} else {
			selectorText.textContent = 'Select Project';
		}
		
		// Populate dropdown
		dropdown.innerHTML = '';
		for (const [projectId, project] of Object.entries(data.projects)) {
			const item = document.createElement('div');
			item.className = `project-item ${projectId === currentProjectId ? 'active' : ''}`;
			item.onclick = (e) => {
				// Don't switch if clicking delete button
				if (e.target.closest('.project-delete-btn')) return;
				setCurrentProject(projectId);
				populateProjectSelect();
				renderCart();
				el('projectDropdown').classList.remove('show');
				el('projectSelectorBtn').classList.remove('active');
				showToast('Switched project');
			};
			
			const info = document.createElement('div');
			info.className = 'project-item-info';
			
			const name = document.createElement('div');
			name.className = 'project-item-name';
			name.textContent = project.name;
			
			const count = document.createElement('div');
			count.className = 'project-item-count';
			count.textContent = `${project.items.length} item${project.items.length === 1 ? '' : 's'}`;
			
			info.appendChild(name);
			info.appendChild(count);
			
			const actions = document.createElement('div');
			actions.className = 'project-item-actions';
			
			// Only show delete if there's more than one project
			if (Object.keys(data.projects).length > 1) {
				const deleteBtn = document.createElement('button');
				deleteBtn.className = 'project-delete-btn';
				deleteBtn.innerHTML = 'üóëÔ∏è';
				deleteBtn.title = 'Delete project';
				deleteBtn.onclick = (e) => {
					e.stopPropagation();
					if (!confirm(`Delete "${project.name}"? This will permanently remove all ${project.items.length} item${project.items.length === 1 ? '' : 's'} in this project.`)) {
						return;
					}
					
					const data = getProjects();
					delete data.projects[projectId];
					
					// If we deleted the current project, switch to another one
					if (projectId === data.currentProject) {
						const remainingProjects = Object.keys(data.projects);
						if (remainingProjects.length > 0) {
							data.currentProject = remainingProjects[0];
						} else {
							// Create a default project if we deleted the last one
							data.projects['default'] = { name: 'Default Project', items: [] };
							data.currentProject = 'default';
						}
					}
					
					saveProjects(data);
					populateProjectSelect();
					renderCart();
					el('projectDropdown').classList.remove('show');
					el('projectSelectorBtn').classList.remove('active');
					showToast('Project deleted');
				};
				actions.appendChild(deleteBtn);
			}
			
			item.appendChild(info);
			item.appendChild(actions);
			dropdown.appendChild(item);
		}
	};

	const renderCart = () => {
		const content = el('cartContent');
		const status = el('cartStatus');
		const cart = loadCart();
		const size = cart.size;
		const currentProjectId = getCurrentProject();
		const data = getProjects();
		const project = data.projects[currentProjectId];
		const projectName = project ? project.name : 'Unknown Project';
		
		status.textContent = `${size} item${size === 1 ? '' : 's'} in "${projectName}"`;

		if (!size) {
			content.innerHTML = '<p class="cart-empty">This project is empty. Go back to the search page and add transactions to your cart.</p>';
			return;
		}

		const tableWrap = document.createElement('div');
		tableWrap.className = 'table-wrap';
		const table = document.createElement('table');

		const thead = document.createElement('thead');
		const hr = document.createElement('tr');
		['PAN', 'Buyer', 'Seller', 'Doc No', 'Year', 'Actions'].forEach(text => {
			const th = document.createElement('th');
			th.textContent = text;
			hr.appendChild(th);
		});
		thead.appendChild(hr);
		table.appendChild(thead);

		const tbody = document.createElement('tbody');
		for (const [key, row] of cart.entries()) {
			const tr = document.createElement('tr');
			const pan = formatField(row, ['pan_numbers', 'PAN', 'pan']);
			const buyer = formatField(row, ['buyer', 'Buyer']);
			const seller = formatField(row, ['seller', 'Seller']);
			const doc = formatField(row, ['DocNo', 'doc_no', 'docno', 'DocumentNo']);
			const year = formatField(row, ['year', 'Year', 'YEAR']);

			[[pan], [buyer], [seller], [doc], [year]].forEach(([text]) => {
				const td = document.createElement('td');
				td.textContent = text;
				tr.appendChild(td);
			});

			const actionTd = document.createElement('td');
			const removeBtn = document.createElement('button');
			removeBtn.className = 'cart-remove';
			removeBtn.textContent = 'Remove';
			removeBtn.onclick = () => {
				const data = getProjects();
				const currentProjectId = getCurrentProject();
				if (data.projects[currentProjectId]) {
					data.projects[currentProjectId].items = data.projects[currentProjectId].items.filter(item => item.key !== key);
					saveProjects(data);
				}
				renderCart();
				showToast('Removed from project');
			};
			actionTd.appendChild(removeBtn);
			tr.appendChild(actionTd);

			tbody.appendChild(tr);
		}
		table.appendChild(tbody);
		tableWrap.appendChild(table);
		content.innerHTML = '';
		content.appendChild(tableWrap);
	};

	el('btnClearCart').onclick = () => {
		const cart = loadCart();
		if (!cart.size) {
			showToast('Project is already empty');
			return;
		}
		if (!confirm('Clear all items from this project?')) return;
		const data = getProjects();
		const currentProjectId = getCurrentProject();
		if (data.projects[currentProjectId]) {
			data.projects[currentProjectId].items = [];
			saveProjects(data);
		}
		renderCart();
		showToast('Project cleared');
	};

	// Toggle dropdown
	el('projectSelectorBtn').onclick = (e) => {
		e.stopPropagation();
		const dropdown = el('projectDropdown');
		const btn = el('projectSelectorBtn');
		const isOpen = dropdown.classList.contains('show');
		
		if (isOpen) {
			dropdown.classList.remove('show');
			btn.classList.remove('active');
		} else {
			dropdown.classList.add('show');
			btn.classList.add('active');
		}
	};
	
	// Close dropdown when clicking outside
	document.addEventListener('click', (e) => {
		const selector = document.querySelector('.project-selector');
		if (selector && !selector.contains(e.target)) {
			el('projectDropdown').classList.remove('show');
			el('projectSelectorBtn').classList.remove('active');
		}
	});

	el('btnNewProject').onclick = () => {
		const name = prompt('Enter project name:');
		if (!name || !name.trim()) return;
		const data = getProjects();
		const projectId = `project_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
		data.projects[projectId] = { name: name.trim(), items: [] };
		data.currentProject = projectId;
		saveProjects(data);
		populateProjectSelect();
		renderCart();
		showToast('Project created');
	};

	populateProjectSelect();
	renderCart();
	el('btnExportCSV').onclick = exportCartCSV;
	el('btnExportPDF').onclick = exportCartPDF;
	</script>
</body>
</html>

