<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Transaction Search</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg: #0a0d12;
			--bg-2: #0b1118;
			--panel: #0e141d;
			--muted: #9fb2c6;
			--text: #eaf1f8;
			--primary: #60d5ff;
			--accent: #9b8cff;
			--danger: #ff6b6b;
			--border: #1a2431;
			--row-alt: #0c131b;
			--focus-ring: rgba(155,140,255,0.35);
			--shadow-1: 0 10px 30px rgba(0,0,0,.35);
			--shadow-2: 0 1px 0 rgba(255,255,255,0.03) inset;
		}
		* { box-sizing: border-box; }
		html, body { height: 100%; }
		::selection { background: rgba(155,140,255,0.35); color: #fff; }
		body { margin: 0; background:
			radial-gradient(1000px 600px at 10% -10%, rgba(96,213,255,0.06), transparent 60%),
			radial-gradient(800px 500px at 100% 0%, rgba(155,140,255,0.07), transparent 55%),
			linear-gradient(180deg, var(--bg), var(--bg-2));
			color: var(--text); font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
		.container { max-width: 1220px; margin: 0 auto; padding: 28px; }
		h1 { font-size: 26px; margin: 0 0 14px; letter-spacing: 0.2px; color: #e7eef6; font-weight: 700; }
		.header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
		.badge { background: linear-gradient(135deg, #131b28, #0f1723); padding: 6px 12px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); font-size: 12px; backdrop-filter: saturate(120%) blur(6px); }

		mark { background: rgba(255, 235, 59, 0.25); color: #fff; padding: 0 .18em; border-radius: 3px; box-shadow: 0 0 0 1px rgba(255, 235, 59, 0.25) inset; }

		.card { background: linear-gradient(180deg, #0e1521, #0c121a); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: var(--shadow-1), var(--shadow-2); backdrop-filter: saturate(115%) blur(6px); }
		.row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
		.col-3 { grid-column: span 3; }
		.col-4 { grid-column: span 4; }
		.col-6 { grid-column: span 6; }
		.col-8 { grid-column: span 8; }

		.input { width: 100%; background: #0b1118; border: 1px solid var(--border); color: var(--text); padding: 12px 12px; border-radius: 12px; outline: none; transition: border-color .2s, box-shadow .2s, background .2s; font-size: 14px; box-shadow: var(--shadow-2); }
		.input::placeholder { color: #6f8194; }
		.input:hover { background: #0c131b; }
		.input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--focus-ring), 0 0 0 1px rgba(255,255,255,0.04) inset; }
		.label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
		.btn { background: linear-gradient(135deg, #253246, #1b2533); color: #e8f3ff; border: 1px solid var(--border); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing: .2px; transition: transform .08s ease, filter .18s ease, box-shadow .18s ease; box-shadow: var(--shadow-2); }
		.btn:hover { filter: brightness(1.08); box-shadow: 0 6px 16px rgba(0,0,0,.35), var(--shadow-2); }
		.btn:active { transform: translateY(1px); }
		.btn:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--focus-ring), var(--shadow-2); }
		.btn-primary { background: linear-gradient(135deg, #2a3c52, #1f2e43); border-color: #2a3a4e; }
		.btn-ghost { background: transparent; }
		.btn[disabled] { opacity: 0.5; cursor: not-allowed; filter: none; }
		/* Inline loading spinner inside buttons */
		.btn .spinner { display: none; width: 14px; height: 14px; border: 2px solid #cfe3ff; border-top-color: transparent; border-radius: 50%; margin-left: 8px; animation: spin .8s linear infinite; }
		.btn.loading .spinner { display: inline-block; }
		.btn.loading .btn-label { opacity: .85; }
		@keyframes spin { to { transform: rotate(360deg); } }

		.toolbar { display: flex; align-items: center; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
		.stat { color: var(--muted); font-size: 12px; padding: 6px 10px; background: #0c131b; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow-2); }

		.table-wrap { margin-top: 16px; background: #0c1219; border: 1px solid var(--border); border-radius: 14px; overflow: hidden; overflow-x: auto; box-shadow: var(--shadow-1), var(--shadow-2); }
		table { width: 100%; border-collapse: collapse; table-layout: auto; }
		thead th { position: sticky; top: 0; background: rgba(16,24,36,0.8); color: #d1deed; font-weight: 600; font-size: 12px; text-align: left; padding: 12px 10px; border-bottom: 1px solid var(--border); white-space: nowrap; backdrop-filter: blur(8px); }
		tbody tr:nth-child(even) { background: var(--row-alt); }
		tbody td { padding: 12px 10px; border-bottom: 1px solid #141b25; font-size: 12px; color: #dce7f5; word-wrap: break-word; word-break: break-word; white-space: normal; vertical-align: top; }
		tbody td:first-child { min-width: 120px; }
		tbody td:nth-child(2), tbody td:nth-child(3) { min-width: 300px; max-width: 680px; }
		tbody tr:hover { background: #0f1823; }

		.pagination { display: flex; gap: 8px; align-items: center; justify-content: flex-end; padding: 10px; border-top: 1px solid var(--border); }
		.select { background: #0b1118; color: var(--text); border: 1px solid var(--border); padding: 8px 10px; border-radius: 10px; box-shadow: var(--shadow-2); }

		.toast { position: fixed; right: 16px; bottom: 16px; padding: 10px 14px; border-radius: 12px; background: #122034; color: var(--text); border: 1px solid var(--border); box-shadow: 0 10px 24px rgba(0,0,0,.4); display: none; }
		.toast.show { display: block; animation: fade 2.2s ease forwards; }
		@keyframes fade { 0% { opacity: 0; transform: translateY(8px); } 10% { opacity: 1; transform: translateY(0);} 90% { opacity: 1;} 100%{ opacity:0; transform: translateY(8px);} }

		.skeleton { background: linear-gradient(90deg, #0e1520 25%, #121b29 37%, #0e1520 63%); background-size: 400% 100%; animation: shimmer 1.2s infinite; border-radius: 12px; height: 38px; }
		@keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

		/* Range slider (Fuzzy threshold) */
		input[type="range"] { appearance: none; -webkit-appearance: none; width: 160px; height: 6px; background: #0f1621; border-radius: 999px; border: 1px solid var(--border); outline: none; box-shadow: var(--shadow-2); }
		input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ffffff, #b7c8ff 60%, #8e7cff 100%); border: 2px solid #1c2230; box-shadow: 0 2px 10px rgba(142,124,255,.45); cursor: pointer; transition: transform .08s ease; }
		input[type="range"]::-webkit-slider-thumb:active { transform: scale(0.98); }
		input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ffffff, #b7c8ff 60%, #8e7cff 100%); border: 2px solid #1c2230; box-shadow: 0 2px 10px rgba(142,124,255,.45); cursor: pointer; }

		/* Scrollbar */
		::-webkit-scrollbar { height: 10px; width: 10px; }
		::-webkit-scrollbar-track { background: #0b1118; }
		::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #273349, #1c2636); border: 2px solid #0b1118; border-radius: 10px; }
		::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #2d3a53, #202a3d); }

		@media (max-width: 900px) {
			.row { grid-template-columns: repeat(12, 1fr); }
			.col-4, .col-6, .col-2, .col-3, .col-8 { grid-column: span 12; }
			.header { flex-direction: column; align-items: flex-start; gap: 8px; }
			.toolbar { flex-direction: column; align-items: stretch; gap: 8px; }
			.table-wrap { margin-top: 12px; }
			.pagination { justify-content: center; }
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>Transactions Search</h1>
			<span class="badge">Dark • Modern • Fast</span>
		</div>

		<div class="card">
			<div class="row">
				<div class="col-4">
					<label class="label">PAN</label>
					<input id="pan" class="input" placeholder="e.g., AAACO8053A" aria-label="PAN number" inputmode="latin" autocomplete="on" name="pan" />
				</div>
				<div class="col-6">
					<label class="label">Name (Marathi or English)</label>
					<input id="seed" class="input" placeholder="e.g., मिताली श्रीनिवास पेंढारकर" aria-label="Person name" autocomplete="on" name="person-name" />
				</div>
				<div class="col-2" style="display:flex; align-items:flex-end; justify-content:flex-end; gap:8px;">
					<button id="btnSearch" class="btn btn-primary" title="Run search (PAN or Name)">Search</button>
					<button id="btnClear" class="btn btn-ghost" title="Clear inputs">Clear</button>
				</div>
			</div>
			<div class="toolbar" style="margin-top:8px;">
			<button id="btnPhonetics" class="btn" title="Suggest phonetic name variations"><span class="btn-label">Suggest phonetics</span><span class="spinner" aria-hidden="true"></span></button>
				<div id="chips" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
			</div>
			<div class="toolbar">
				<span id="stat" class="stat">Ready</span>
				<span id="extracted" class="stat" style="display:none;"></span>
				<div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
					<label class="label" style="margin:0;">Fuzzy threshold</label>
					<input id="threshold" type="range" min="0" max="100" value="75" step="1" style="width:140px;" aria-label="Fuzzy match threshold" />
					<span id="thresholdValue" class="stat">75</span>
				</div>
				<div style="display:flex; gap:8px; align-items:center;">
					<label class="label" style="margin:0;">Page size</label>
					<select id="pageSize" class="select">
						<option>20</option>
						<option>50</option>
						<option selected>100</option>
						<option>200</option>
					</select>
					<button id="btnExport" class="btn" title="Export current results as CSV">Export CSV</button>
				</div>
			</div>
		</div>

		<div class="table-wrap" id="tableWrap" style="margin-top:16px;">
			<div id="loading" class="skeleton" style="display:none;"></div>
			<table id="table" style="display:none;"></table>
			<div class="pagination" id="pager" style="display:none;">
				<button class="btn" id="prev">Prev</button>
				<span id="pageInfo" class="stat">Page-1 / 1</span>
				<button class="btn" id="next">Next</button>
			</div>
		</div>
	</div>

	<div class="toast" id="toast"></div>

	<script>
	// Use localhost when opened via file://, otherwise keep same host at port 8000
	const API_BASE = (location.protocol === 'file:') ? 'http://localhost:8000' : `${location.protocol}//${location.hostname || 'localhost'}:8000`;
	const el = id => document.getElementById(id);
			let state = { allRows: [], rows: [], colsDisplay: [], colMap: {}, page: 1, pageSize: 100, threshold: 0.75 };

	function showToast(msg){ const t = el('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }
	function setStatus(msg){ el('stat').textContent = msg; }
	function setLoading(on){ el('loading').style.display = on ? 'block':'none'; el('table').style.display = on ? 'none':'table'; el('pager').style.display = on ? 'none':'flex'; }

	async function fetchPhonetics(){
		const seed = el('seed').value.trim();
		if (!seed){ showToast('Enter a name'); return; }
		const btn = el('btnPhonetics');
		btn.disabled = true; btn.classList.add('loading');
		try {
			const res = await fetch(`${API_BASE}/phonetics?` + new URLSearchParams({seed_name: seed}));
			if (!res.ok) throw new Error(await res.text());
			const json = await res.json();
			const chips = el('chips'); chips.innerHTML = '';
			const makeChip = (text) => { const b = document.createElement('button'); b.className='btn'; b.style.padding='6px 10px'; b.textContent = text; b.onclick=()=>{ el('seed').value = text; }; return b; };
			const eng = Array.from(json.variations?.english || []).slice(0, 12);
			const dev = Array.from(json.variations?.marathi || []).slice(0, 12);
			for (const v of eng) chips.appendChild(makeChip(v));
			for (const v of dev) chips.appendChild(makeChip(v));
			showToast('Phonetic suggestions updated');
		} catch(e){ console.error(e); showToast('Phonetics failed'); }
		finally { btn.disabled = false; btn.classList.remove('loading'); }
	}

	async function fetchSearch(){
		const pan = el('pan').value.trim();
		const seed = el('seed').value.trim();
		if (!pan && !seed){ showToast('Enter PAN or Name'); return; }
		const qs = new URLSearchParams();
		if (pan) qs.set('pan', pan);
		if (seed) qs.set('seed_name', seed);
		qs.set('limit', '5000');
		setStatus('Searching…'); setLoading(true);
		try {
			const res = await fetch(`${API_BASE}/search?${qs.toString()}`);
			if (!res.ok) throw new Error(await res.text());
			const json = await res.json();
			state.allRows = json.data || [];
			// If PAN provided, fetch Name/Age from external API and inject into rows
			let metaName = null, metaAge = null;
			if (pan) {
				try {
					const ext = await fetch(`${API_BASE}/pan_meta?` + new URLSearchParams({ pan }));
					if (ext.ok) {
						const ej = await ext.json().catch(()=>({}));
						// Expect normalized keys from proxy
						metaName = (ej.extracted_name ?? ej.name) ?? null;
						metaAge = ej.age ?? null;
						// Normalize to primitives
						if (typeof metaName !== 'string') metaName = metaName != null ? String(metaName) : null;
						if (typeof metaAge !== 'number') {
							const parsed = ej && (ej.age ?? ej.Age);
							const n = Number(parsed);
							metaAge = Number.isFinite(n) ? n : (parsed != null ? String(parsed) : null);
						}
						if (metaName != null || metaAge != null) {
							for (const r of state.allRows) { r["Name"] = metaName ?? ''; r["Age"] = metaAge ?? ''; }
						}
							// Show name badge; label as Extracted only if extracted_name present
							const ex = el('extracted');
							if (metaName) {
								ex.style.display = 'inline-block';
								const isExtracted = ej && typeof ej.extracted_name === 'string' && ej.extracted_name.length > 0;
								ex.textContent = `${isExtracted ? 'Extracted Name' : 'Name'}: ${metaName}`;
							} else {
								ex.style.display = 'none';
								ex.textContent = '';
							}
					} else {
						// Non-fatal if metadata API fails
						console.warn('Meta API failed', await ext.text());
					}
				} catch (e) {
					console.warn('Meta API error', e);
				}
			}
			// Lock table to exactly these columns in this order
			const desired = [
				{ header: 'PAN', key: 'pan_numbers' },
				{ header: 'Buyer', key: 'buyer' },
				{ header: 'Seller', key: 'seller' },
				{ header: 'Name', key: 'Name' },
				{ header: 'Age', key: 'Age' },
			];
			state.colsDisplay = desired.map(d => d.header);
			state.colMap = Object.fromEntries(desired.map(d => [d.header, d.key]));
			state.page = 1;
			applyThreshold();
			render();
			setStatus(`Found ${state.rows.length.toLocaleString()} rows (threshold ${Math.round(state.threshold*100)})`);
			showToast('Done');
		} catch(e){
			console.error(e);
			setStatus('Error');
			showToast('Search failed');
		} finally { setLoading(false); }
	}

	function paginate(rows, page, size){
		const start = (page-1)*size;
		return rows.slice(start, start+size);
	}

	function render(){
		const table = el('table');
		table.innerHTML = '';
		if (!state.rows.length){ table.style.display='none'; el('pager').style.display='none'; return; }
		table.style.display='table';
		const thead = document.createElement('thead');
		const htr = document.createElement('tr');
		for (const c of state.colsDisplay){ const th = document.createElement('th'); th.textContent = c; htr.appendChild(th); }
		thead.appendChild(htr);
		table.appendChild(thead);
		const tbody = document.createElement('tbody');
		const pageRows = paginate(state.rows, state.page, state.pageSize);
			for (const r of pageRows){
				const tr = document.createElement('tr');
				for (const c of state.colsDisplay){
					const td = document.createElement('td');
					const key = state.colMap[c];
					const v = r[key];
					// If this column maps to the hit field, render the HTML snippet with <mark>
					if (r.name_hit_field === key && r.name_hit_snippet_html){
						td.innerHTML = String(r.name_hit_snippet_html);
					} else if (r.pan_hit_field === key && r.pan_hit_snippet_html){
						// For PAN hits, show the FULL field value, not just the snippet
						// Highlight the PAN within the full text
						const fullText = String(v || '');
						if (fullText && r.pan_hit_snippet_html) {
							// Extract the PAN from the snippet (it's marked with <mark>)
							const panMatch = r.pan_hit_snippet_html.match(/<mark>([^<]+)<\/mark>/);
							if (panMatch) {
								const panToHighlight = panMatch[1];
								// Replace all occurrences of the PAN in the full text with highlighted version
								const regex = new RegExp(panToHighlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
								const highlighted = fullText.replace(regex, (match) => `<mark>${match}</mark>`);
								td.innerHTML = highlighted;
							} else {
								td.innerHTML = fullText;
							}
						} else {
							td.textContent = fullText;
						}
					} else {
						td.textContent = (v!==null && v!==undefined) ? String(v) : '';
					}
					tr.appendChild(td);
				}
				tbody.appendChild(tr);
			}
		table.appendChild(tbody);
		const pages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
		el('pageInfo').textContent = `Page ${state.page} / ${pages}`;
		const prevBtn = el('prev');
		const nextBtn = el('next');
		prevBtn.disabled = state.page <= 1;
		nextBtn.disabled = state.page >= pages;
		el('pager').style.display = 'flex';
	}

	function applyThreshold(){
		const thr = state.threshold;
		if (!Array.isArray(state.allRows)) { state.rows = []; return; }
		state.rows = state.allRows.filter(r => {
			const s = typeof r.match_score === 'number' ? r.match_score : 0;
			return s >= thr;
		});
		state.page = 1;
	}

	function exportCSV(){
		if (!state.rows.length){ showToast('No data'); return; }
		const cols = state.colsDisplay;
		const lines = [];
		lines.push(cols.map(safeCsv).join(','));
		for (const r of state.rows){ lines.push(cols.map(c=>safeCsv(r[state.colMap[c]])).join(',')); }
		const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url; a.download = 'results.csv'; a.click(); URL.revokeObjectURL(url);
		showToast('Exported CSV');
	}
	function safeCsv(v){ if (v===null||v===undefined) return ''; const s = String(v).replace(/"/g,'""'); return /[",\n]/.test(s) ? `"${s}"` : s; }

	el('btnSearch').onclick = fetchSearch;
	el('btnPhonetics').onclick = fetchPhonetics;
	el('btnClear').onclick = () => { el('pan').value=''; el('seed').value=''; setStatus('Ready'); };
	el('btnExport').onclick = exportCSV;
	el('prev').onclick = ()=>{ if (state.page>1){ state.page--; render(); }};
	el('next').onclick = ()=>{ const pages = Math.max(1, Math.ceil(state.rows.length / state.pageSize)); if (state.page<pages){ state.page++; render(); }};
	el('pageSize').onchange = (e)=>{ state.pageSize = parseInt(e.target.value, 10) || 100; state.page = 1; render(); };
	const thresholdEl = el('threshold');
	const thresholdValue = el('thresholdValue');
	thresholdEl.oninput = (e)=>{
		const v = parseInt(e.target.value, 10);
		thresholdValue.textContent = String(v);
		state.threshold = isFinite(v) ? (v/100) : 0.75;
		applyThreshold();
		render();
	};
	</script>
</body>
</html>
