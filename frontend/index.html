<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Transaction Search</title>
	<style>
		:root {
			--bg: #0b0f14;
			--panel: #111822;
			--muted: #8aa0b4;
			--text: #e6edf3;
			--primary: #5ac8fa;
			--accent: #8e7cff;
			--danger: #ff6b6b;
			--border: #1f2a37;
		}
		mark { background: #ffeb3b; color: #111; padding: 0 .15em; border-radius: 2px; }
		* { box-sizing: border-box; }
		html, body { height: 100%; }
		body { margin: 0; background: linear-gradient(180deg, #0b0f14, #0a0d12); color: var(--text); font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
		.container { max-width: 1600px; margin: 0 auto; padding: 24px; }
		h1 { font-size: 20px; margin: 0 0 16px; letter-spacing: 0.3px; color: #dbe7f3; }
		.header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
		.badge { background: linear-gradient(135deg, #1a2330, #121a24); padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); font-size: 12px; }

		.card { background: linear-gradient(180deg, #0f1520, #0e141d); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.02); }
		.row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
		.col-3 { grid-column: span 3; }
		.col-4 { grid-column: span 4; }
		.col-6 { grid-column: span 6; }
		.col-8 { grid-column: span 8; }

		.input { width: 100%; background: #0c121a; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 10px; outline: none; transition: border-color .2s; font-size: 14px; }
		.input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(142,124,255,0.15); }
		.label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
		.btn { background: linear-gradient(135deg, #263246, #1b2533); color: #e8f3ff; border: 1px solid var(--border); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing: .2px; }
		.btn:hover { filter: brightness(1.1); }
		.btn-primary { background: linear-gradient(135deg, #2b3e52, #203044); border-color: #2a3a4e; }
		.btn-ghost { background: transparent; }

		.toolbar { display: flex; align-items: center; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
		.stat { color: var(--muted); font-size: 12px; padding: 6px 10px; background: #0d141d; border: 1px solid var(--border); border-radius: 10px; }

		.table-wrap { margin-top: 16px; background: #0c1219; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
		table { width: 100%; border-collapse: collapse; }
		thead th { position: sticky; top: 0; background: #101824; color: #c8d6e5; font-weight: 600; font-size: 12px; text-align: left; padding: 10px; border-bottom: 1px solid var(--border); }
			tbody td { padding: 10px; border-bottom: 1px solid #141b25; font-size: 12px; color: #d6e2ef; white-space: pre-wrap; word-break: break-word; }
		tbody tr:hover { background: #0f1823; }

		.pagination { display: flex; gap: 8px; align-items: center; justify-content: flex-end; padding: 10px; border-top: 1px solid var(--border); }
		.select { background: #0c121a; color: var(--text); border: 1px solid var(--border); padding: 8px 10px; border-radius: 8px; }

		.toast { position: fixed; right: 16px; bottom: 16px; padding: 10px 14px; border-radius: 10px; background: #122034; color: var(--text); border: 1px solid var(--border); box-shadow: 0 10px 24px rgba(0,0,0,.4); display: none; }
		.toast.show { display: block; animation: fade 2.2s ease forwards; }
		@keyframes fade { 0% { opacity: 0; transform: translateY(8px); } 10% { opacity: 1; transform: translateY(0);} 90% { opacity: 1;} 100%{ opacity:0; transform: translateY(8px);} }

		.skeleton { background: linear-gradient(90deg, #0e1520 25%, #121b29 37%, #0e1520 63%); background-size: 400% 100%; animation: shimmer 1.2s infinite; border-radius: 8px; height: 38px; }
		@keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>Transactions Search</h1>
			<span class="badge">Dark • Modern • Fast</span>
		</div>

		<div class="card">
			<div class="row">
				<div class="col-4">
					<label class="label">PAN</label>
					<input id="pan" class="input" placeholder="e.g., AAACO8053A" />
				</div>
				<div class="col-6">
					<label class="label">Name (Marathi or English)</label>
					<input id="seed" class="input" placeholder="e.g., मिताली श्रीनिवास पेंढारकर" />
				</div>
				<div class="col-2" style="display:flex; align-items:flex-end; justify-content:flex-end; gap:8px;">
					<button id="btnSearch" class="btn btn-primary">Search</button>
					<button id="btnClear" class="btn btn-ghost">Clear</button>
				</div>
			</div>
			<div class="toolbar" style="margin-top:8px;">
				<button id="btnPhonetics" class="btn">Suggest phonetics</button>
				<div id="chips" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
			</div>
			<div class="toolbar">
				<span id="stat" class="stat">Ready</span>
				<div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
					<label class="label" style="margin:0;">Page size</label>
					<select id="pageSize" class="select">
						<option>20</option>
						<option>50</option>
						<option selected>100</option>
						<option>200</option>
					</select>
					<button id="btnExport" class="btn">Export CSV</button>
				</div>
			</div>
		</div>

		<div class="table-wrap" id="tableWrap" style="margin-top:16px;">
			<div id="loading" class="skeleton" style="display:none;"></div>
			<table id="table" style="display:none;"></table>
			<div class="pagination" id="pager" style="display:none;">
				<button class="btn" id="prev">Prev</button>
				<span id="pageInfo" class="stat">Page-1 / 1</span>
				<button class="btn" id="next">Next</button>
			</div>
		</div>
	</div>

	<div class="toast" id="toast"></div>

	<script>
	// Use localhost when opened via file://, otherwise keep same host at port 8000
	const API_BASE = (location.protocol === 'file:') ? 'http://localhost:8000' : `${location.protocol}//${location.hostname || 'localhost'}:8000`;
	const el = id => document.getElementById(id);
	let state = { rows: [], colsDisplay: [], colMap: {}, page: 1, pageSize: 100 };

	function showToast(msg){ const t = el('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }
	function setStatus(msg){ el('stat').textContent = msg; }
	function setLoading(on){ el('loading').style.display = on ? 'block':'none'; el('table').style.display = on ? 'none':'table'; el('pager').style.display = on ? 'none':'flex'; }

	async function fetchPhonetics(){
		const seed = el('seed').value.trim();
		if (!seed){ showToast('Enter a name'); return; }
		try {
			const res = await fetch(`${API_BASE}/phonetics?` + new URLSearchParams({seed_name: seed}));
			if (!res.ok) throw new Error(await res.text());
			const json = await res.json();
			const chips = el('chips'); chips.innerHTML = '';
			const makeChip = (text) => { const b = document.createElement('button'); b.className='btn'; b.style.padding='6px 10px'; b.textContent = text; b.onclick=()=>{ el('seed').value = text; }; return b; };
			const eng = Array.from(json.variations?.english || []).slice(0, 12);
			const dev = Array.from(json.variations?.marathi || []).slice(0, 12);
			for (const v of eng) chips.appendChild(makeChip(v));
			for (const v of dev) chips.appendChild(makeChip(v));
			showToast('Phonetic suggestions updated');
		} catch(e){ console.error(e); showToast('Phonetics failed'); }
	}

	async function fetchSearch(){
		const pan = el('pan').value.trim();
		const seed = el('seed').value.trim();
		if (!pan && !seed){ showToast('Enter PAN or Name'); return; }
		const qs = new URLSearchParams();
		if (pan) qs.set('pan', pan);
		if (seed) qs.set('seed_name', seed);
		qs.set('limit', '5000');
		setStatus('Searching…'); setLoading(true);
		try {
			const res = await fetch(`${API_BASE}/search?${qs.toString()}`);
			if (!res.ok) throw new Error(await res.text());
			const json = await res.json();
			state.rows = json.data || [];
			// If PAN provided, fetch Name/Age from external API and inject into rows
			let metaName = null, metaAge = null;
			if (pan) {
				try {
					const ext = await fetch(`${API_BASE}/pan_meta?` + new URLSearchParams({ pan }));
					if (ext.ok) {
						const ej = await ext.json().catch(()=>({}));
						// Expect normalized keys from proxy
						metaName = ej.name ?? null;
						metaAge = ej.age ?? null;
						// Normalize to primitives
						if (typeof metaName !== 'string') metaName = metaName != null ? String(metaName) : null;
						if (typeof metaAge !== 'number') {
							const parsed = ej && (ej.age ?? ej.Age);
							const n = Number(parsed);
							metaAge = Number.isFinite(n) ? n : (parsed != null ? String(parsed) : null);
						}
						if (metaName != null || metaAge != null) {
							for (const r of state.rows) { r["Name"] = metaName ?? ''; r["Age"] = metaAge ?? ''; }
						}
					} else {
						// Non-fatal if metadata API fails
						console.warn('Meta API failed', await ext.text());
					}
				} catch (e) {
					console.warn('Meta API error', e);
				}
			}
			// Lock table to exactly these columns in this order
			const desired = [
				{ header: 'PAN', key: 'pan_numbers' },
				{ header: 'Buyer', key: 'buyer' },
				{ header: 'Seller', key: 'seller' },
				{ header: 'Name', key: 'Name' },
				{ header: 'Age', key: 'Age' },
			];
			state.colsDisplay = desired.map(d => d.header);
			state.colMap = Object.fromEntries(desired.map(d => [d.header, d.key]));
			state.page = 1;
			render();
			setStatus(`Found ${state.rows.length.toLocaleString()} rows`);
			showToast('Done');
		} catch(e){
			console.error(e);
			setStatus('Error');
			showToast('Search failed');
		} finally { setLoading(false); }
	}

	function paginate(rows, page, size){
		const start = (page-1)*size;
		return rows.slice(start, start+size);
	}

	function render(){
		const table = el('table');
		table.innerHTML = '';
		if (!state.rows.length){ table.style.display='none'; el('pager').style.display='none'; return; }
		table.style.display='table';
		const thead = document.createElement('thead');
		const htr = document.createElement('tr');
		for (const c of state.colsDisplay){ const th = document.createElement('th'); th.textContent = c; htr.appendChild(th); }
		thead.appendChild(htr);
		table.appendChild(thead);
		const tbody = document.createElement('tbody');
		const pageRows = paginate(state.rows, state.page, state.pageSize);
		for (const r of pageRows){
			const tr = document.createElement('tr');
			for (const c of state.colsDisplay){
				const td = document.createElement('td');
				const key = state.colMap[c];
				const v = r[key];
				// If this column maps to the hit field, render the HTML snippet with <mark>
				if (r.name_hit_field === key && r.name_hit_snippet_html){
					td.innerHTML = String(r.name_hit_snippet_html);
				} else if (key === 'pan_numbers'){
					// Always show full PAN in one line (no snippet)
					td.textContent = (v!==null && v!==undefined) ? String(v) : '';
					td.style.whiteSpace = 'nowrap';
				} else {
					// Show full content for all fields (no truncation), so Buyer/Seller are complete
					td.textContent = (v!==null && v!==undefined) ? String(v) : '';
				}
				tr.appendChild(td);
			}
			tbody.appendChild(tr);
		}
		table.appendChild(tbody);
		const pages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
		el('pageInfo').textContent = `Page ${state.page} / ${pages}`;
		el('pager').style.display = 'flex';
	}

	function exportCSV(){
		if (!state.rows.length){ showToast('No data'); return; }
		const cols = state.colsDisplay;
		const lines = [];
		lines.push(cols.map(safeCsv).join(','));
		for (const r of state.rows){ lines.push(cols.map(c=>safeCsv(r[state.colMap[c]])).join(',')); }
		const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url; a.download = 'results.csv'; a.click(); URL.revokeObjectURL(url);
		showToast('Exported CSV');
	}
	function safeCsv(v){ if (v===null||v===undefined) return ''; const s = String(v).replace(/"/g,'""'); return /[",\n]/.test(s) ? `"${s}"` : s; }

	el('btnSearch').onclick = fetchSearch;
	el('btnPhonetics').onclick = fetchPhonetics;
	el('btnClear').onclick = () => { el('pan').value=''; el('seed').value=''; setStatus('Ready'); };
	el('btnExport').onclick = exportCSV;
	el('prev').onclick = ()=>{ if (state.page>1){ state.page--; render(); }};
	el('next').onclick = ()=>{ const pages = Math.max(1, Math.ceil(state.rows.length / state.pageSize)); if (state.page<pages){ state.page++; render(); }};
	el('pageSize').onchange = (e)=>{ state.pageSize = parseInt(e.target.value, 10) || 100; state.page = 1; render(); };
	</script>
</body>
</html>
